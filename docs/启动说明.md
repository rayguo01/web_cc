# Viral-X 启动说明

Viral-X 是一个 AI 驱动的 X 平台爆款内容生成器，支持热点追踪、内容生成、爆款优化和一键发布。

## 前置条件

### 1. 安装 Node.js

需要 Node.js 18 或更高版本。

```bash
# Ubuntu
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version  # 应显示 v18.x 或更高
npm --version
```

### 2. PostgreSQL 数据库

项目使用 PostgreSQL 数据库（推荐使用 [Neon](https://neon.tech) 云数据库）。

---

## 环境变量配置

在项目根目录创建 `.env` 文件：

```bash
# 数据库连接（必需）
DATABASE_URL=postgresql://user:password@host/dbname?sslmode=require&schema=web_cc

# JWT 密钥（必需，生产环境请使用强密钥）
JWT_SECRET=your-super-secret-jwt-key

# 服务端口（可选，默认 3000）
PORT=3000

# Twitter OAuth 2.0（X 登录和发布功能）
TWITTER_CLIENT_ID=your-twitter-client-id
TWITTER_CLIENT_SECRET=your-twitter-client-secret
TWITTER_CALLBACK_URL=https://your-domain.com/api/twitter/callback

# Twitter API（推文抓取，从 twitterapi.io 获取）
TWITTER_API_IO_KEY=your-twitter-api-io-key

# Gemini API（AI 图片生成）
GEMINI_API_KEY=your-gemini-api-key
```

### 环境变量说明

| 变量 | 必需 | 说明 |
|------|------|------|
| `DATABASE_URL` | 是 | PostgreSQL 连接串，需包含 `schema=web_cc` |
| `JWT_SECRET` | 是 | JWT 签名密钥 |
| `PORT` | 否 | 服务端口，默认 3000 |
| `TWITTER_CLIENT_ID` | 是 | Twitter OAuth 2.0 Client ID |
| `TWITTER_CLIENT_SECRET` | 是 | Twitter OAuth 2.0 Client Secret |
| `TWITTER_CALLBACK_URL` | 是 | Twitter OAuth 回调地址 |
| `TWITTER_API_IO_KEY` | 是 | twitterapi.io API Key（用于抓取推文） |
| `GEMINI_API_KEY` | 否 | Google Gemini API Key（用于生成配图） |

---

## 启动应用

### 1. 安装依赖

```bash
cd /path/to/web-cc
npm install
```

### 2. 启动服务

```bash
# 开发模式（支持热重载）
npm run dev

# 生产模式
npm start
```

### 3. 访问应用

- 落地页：http://localhost:3000/
- 登录页：http://localhost:3000/login.html
- 管理后台：http://localhost:3000/admin.html（需管理员权限）

### 4. 测试账号

```
用户名：rayguo
密码：123456
```

---

## 服务器部署（Ubuntu）

### 方式一：PM2 守护进程（推荐）

```bash
# 安装 PM2
npm install -g pm2

# 启动应用
cd /path/to/web-cc
pm2 start src/server.js --name viral-x

# 开机自启
pm2 startup
pm2 save

# 常用命令
pm2 logs viral-x      # 查看日志
pm2 restart viral-x   # 重启
pm2 stop viral-x      # 停止
pm2 status            # 查看状态
```

### 方式二：systemd 服务

创建 `/etc/systemd/system/viral-x.service`：

```ini
[Unit]
Description=Viral-X Application
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/app/web_cc
ExecStart=/usr/bin/node src/server.js
Restart=on-failure
RestartSec=10
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable viral-x
sudo systemctl start viral-x
sudo systemctl status viral-x
```

---

## Nginx 反向代理配置

```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

## 常见问题

### 数据库连接失败

```
error: relation "xxx" does not exist
```

**解决方案**：
1. 确认 `DATABASE_URL` 包含 `schema=web_cc` 参数
2. 重启服务，让数据库自动初始化表结构

### Twitter 登录失败

1. 确认 `TWITTER_CLIENT_ID` 和 `TWITTER_CLIENT_SECRET` 正确
2. 确认 `TWITTER_CALLBACK_URL` 与 Twitter Developer Portal 中配置的回调地址一致
3. 检查域名是否已添加到 Twitter App 的允许列表

### 端口被占用

```bash
# 查看占用端口的进程
lsof -i :3000

# 杀死进程
kill -9 <PID>
```

### 查看应用日志

```bash
# PM2 日志
pm2 logs viral-x --lines 100

# systemd 日志
journalctl -u viral-x -f
```

---

## 项目结构

```
web-cc/
├── src/                    # 后端代码
│   ├── server.js           # 入口文件
│   ├── routes/             # API 路由
│   ├── services/           # 服务层
│   └── config/             # 配置
├── public/                 # 前端静态文件
│   ├── js/generator/       # 生成器模块
│   ├── css/                # 样式文件
│   ├── index.html          # 落地页
│   ├── login.html          # PC 登录页
│   └── login-mobile.html   # 移动端登录页
├── .claude/                # AI Skill 脚本
├── docs/                   # 文档
└── .env                    # 环境变量（不提交）
```

---

## 参考资料

- [Twitter Developer Portal](https://developer.twitter.com/)
- [Neon 数据库](https://neon.tech/)
- [Google AI Studio](https://aistudio.google.com/)（获取 Gemini API Key）
