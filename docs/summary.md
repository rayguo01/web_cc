# Web Claude Code 项目概要

## 当前版本: v2.18.0

## 项目定位

自动 X 平台热帖生成器，通过抓取热点、AI 分析、内容创作、配图生成的完整流程，自动产出高质量帖子。

## 核心功能模块

### 1. 趋势抓取系统
- **X 趋势**：通过 Twitter API 抓取热门话题和推文
- **TopHub 趋势**：抓取国内多平台热点（微博、知乎、B站等）
- **领域趋势 (domain-trends)**：追踪特定领域 KOL 动态（Web3、AI 等）
  - 支持 KOL 分组轮换抓取，优化 API 调用
  - 两阶段执行模式（抓取 + 分析分离）
  - 数据库缓存机制

### 2. 内容生成系统
- **AI 集成**：通过 AI 调用生成内容
- **三版本输出**：爆款版、深度版、融合版
- **写作风格模拟**：支持模仿特定推主的语气
- **健壮 JSON 解析**：多层回退机制确保解析成功

### 3. 语气模仿器市场 (voice-mimicker)
- 抓取指定推主推文，分析写作风格
- 生成模仿 Prompt（含 Role 和 Core Traits）
- 市场系统：用户可开放自己的模仿器供他人订阅
- 订阅系统：用户可订阅他人的模仿器
- 内容生成时三列选择器（热门/我的/订阅）

### 4. 图片生成系统
- **Gemini AI 绘图**：使用 Google Gemini API 生成配图

### 5. 爆款验证系统
- 对生成内容进行评分（好奇心、共鸣度、清晰度、传播值）
- 提供优化建议

### 6. 用户系统
- JWT 认证
- Twitter OAuth 2.0 登录
- 用户配置和偏好保存

### 7. Token 使用统计系统
- **用量追踪**：记录每次 AI 调用的 Token 消耗和费用
- **层级分解**：用户总量 → 任务 → 工作流步骤 → Skill
- **用户统计**：个人页面显示使用统计卡片（日/周/月筛选）
- **管理后台**：全局统计、用户管理、详情查看
- **管理员权限**：通过 is_admin 字段控制访问权限

## 技术架构

```
前端: HTML/CSS/JavaScript (原生)
后端: Node.js + Express
数据库: SQLite
AI: Anthropic API + Gemini API
外部API: Twitter API, TopHub
```

## 关键文件结构

```
.claude/
  ├── content-writer/     # 内容生成 Skill
  ├── voice-mimicker/     # 语气模仿器
  ├── viral-verification/ # 爆款验证
  ├── image-search/       # 图片搜索
  ├── prompt-generator/   # Prompt 生成
  ├── domain-trends/      # 领域趋势
  └── utils/
      ├── json-parser.ts  # 健壮 JSON 解析
      └── claude-cli.ts   # Claude CLI 调用封装

src/
  ├── routes/
  │   ├── tasks.js        # Skill 执行 API
  │   ├── tools.js        # 工具 API
  │   ├── stats.js        # 用户统计 API
  │   ├── admin.js        # 管理员 API
  │   └── trends.js       # 趋势 API
  ├── middleware/
  │   └── adminAuth.js    # 管理员权限中间件
  ├── services/
  │   ├── scheduler.js    # 定时任务调度
  │   ├── xTrendsDb.js    # 趋势数据存储
  │   └── tokenUsageDb.js # Token 使用统计
  └── db/                 # 数据库初始化

public/
  ├── js/generator/       # 生成器前端
  ├── css/                # 样式文件
  ├── admin.html          # 管理后台
  └── landing.html        # 营销落地页
```

## 版本里程碑

| 版本 | 主要功能 |
|------|---------|
| v1.0 | 基础架构、AI 集成 |
| v1.5 | Skill 工具栏和缓存机制 |
| v1.7 | 内容创作、爆款验证、Gemini 绘图 |
| v2.0 | X 帖子生成器完整流程 |
| v2.2 | 定时趋势抓取系统 |
| v2.4 | 双主题系统（Light/Dark） |
| v2.6 | 图片生成流程拆分 |
| v2.7 | Twitter OAuth 2.0 集成 |
| v2.8 | 健壮 JSON 解析、选题链接、历史数据 |
| v2.9 | 领域趋势追踪、语气模仿器 |
| v2.10 | 一级导航系统 |
| v2.11 | 语气模仿器市场系统 |
| v2.12 | Organic Path 设计系统重构、多主题支持 |
| v2.13 | Cinematic Enterprise Luxury 设计系统 |
| v2.14 | Tailwind CSS 重构 + 玻璃面板设计 |
| v2.15 | Viral-X 落地页 |
| v2.16 | 全站图标系统升级 + 中文黑体 |
| v2.17 | 图片描述与生成图片环节整合 |
| v2.18 | Token 使用统计系统 |

## 最近更新

### v2.18.0 - Token 使用统计系统
- **数据库变更**:
  - 新增 `token_usage` 表：记录每次 AI 调用的详细信息
  - `users` 表新增 `is_admin` 字段：标识管理员用户
- **后端服务**:
  - 新增 `tokenUsageDb.js`：Token 使用数据库操作服务
  - 新增 `/api/stats` 路由：用户统计 API
  - 新增 `/api/admin` 路由：管理员统计和用户管理 API
  - 新增 `adminAuth.js` 中间件：管理员权限验证
- **Skill 改造**:
  - 7 个 Skill 脚本改用 `--output-format json` 获取 usage 数据
  - 新增 `.claude/utils/claude-cli.ts` 统一调用封装
  - 输出 JSON 包含 `_usage` 字段供后端提取
- **tasks.js 改造**:
  - 执行步骤后提取 `_usage` 数据
  - 同步记录到 `token_usage` 表
- **前端功能**:
  - 用户个人页面新增统计卡片（日/周/月筛选）
  - 显示总 Token、总花费、调用次数、任务数
  - 按工作流步骤和 Skill 分组统计
- **管理后台** (`/admin.html`):
  - 全局统计概览（总 Token、总花费、调用次数、活跃用户）
  - 用户列表（搜索、排序、分页）
  - 用户详情弹窗（查看用户统计明细）
  - 管理员权限管理（设置/取消管理员）
- **初始管理员**:
  - 数据库初始化时自动设置 rayguo 为管理员

### v2.17.1 - 语气模仿器创建弹窗优化
- **UI 优化**: "创建新生成器"从展开式输入区域改为图标按钮
- **弹窗交互**: 点击图标后弹出创建弹窗，在弹窗中输入用户名并分析
- **新增元素**:
  - `btn-icon-create`: 标题右侧的圆形加号图标按钮
  - `create-modal`: 创建生成器弹窗
- **交互流程**:
  - 点击 + 图标 → 打开弹窗 → 输入用户名 → 开始分析 → 完成后自动关闭
  - 分析中禁止关闭弹窗，防止误操作
- **界面简化**: 移除原有的 create-section 区域，页面更加简洁

### v2.17.0 - 图片描述与生成图片环节整合
- **工作流简化**: 将"图片描述"和"生成图片"两个独立步骤整合为一个"生成图片"环节
- **工作流步骤**: trends → content → optimize → image → submit（从6步变为5步）
- **三子页面状态机**:
  - 页面1: 生成图片描述（显示内容预览 + "生成图片描述"和"跳过图片"按钮）
  - 页面2: 编辑图片描述（可编辑 prompt + 风格/氛围/色调/视觉元素 + "重新生成描述"按钮）
  - 页面3: 生成图片（prompt 预览 + "生成图片"按钮 + 图片预览）
- **跳转规则**:
  - 页面1 ↔ 页面2: 可以
  - 页面2 ↔ 页面3: 可以
  - 页面1 ↔ 页面3: 禁止（必须经过页面2）
- **自动跳转**: 页面1生成描述后自动跳转到页面2，页面3生成图片后停留当前页面
- **删除文件**: prompt.js 已删除，功能整合到 image.js

### v2.16.1 - 生成器页面按钮与流程优化
- **按钮样式统一**: 修复登录页和应用内按钮阴影不一致问题
- **内容生成页**:
  - 移除"跳过优化"按钮
  - "下一步: 优化"改为 secondary 样式
  - 未生成内容时"下一步"按钮禁用
  - 返回时添加"查看生成内容"按钮
  - "修改输入"改为"修改输入话题内容"
- **优化内容页**:
  - 未优化时"返回编辑"改为"返回内容生成"
  - 移除"跳过图片"按钮
  - 添加"跳过优化"按钮（与"开始爆款优化"并列）
  - "优化意见"改为"更多优化意见"
- **图片描述页**:
  - 改为手动触发模式（非自动生成）
  - 初始显示待生成描述内容预览
  - 添加"生成图片描述"和"跳过图片描述"按钮
- **配图页**:
  - 移除"搜索网图"功能，仅保留 AI 生成
  - 代码从 566 行精简到 319 行

### v2.16.0 - 全站图标系统升级 + 中文黑体
- **图标系统迁移**: 将所有 Emoji 替换为 Google Material Symbols
  - 页面图标: home.js, trends.js, content.js, optimize.js, prompt.js, image.js, submit.js, history.js, voice-mimicker.js, app.js
  - 优先级图标: 红圈+字 → keyboard_double_arrow_up (高), keyboard_arrow_up (中), keyboard_arrow_down (低)
  - 评分图标: 🔥👍💪 → local_fire_department, thumb_up, fitness_center
- **字体系统升级**: 全站中文改用黑体
  - CSS 变量添加 SimHei, Heiti SC, Microsoft YaHei 字体回退
  - Tailwind fontFamily 配置更新
- **样式统一**:
  - 热帖抓取 tab 选中色: 深灰 #374151
  - 时间轴选中/当前/悬停: 统一使用 #374151
  - 领域选择 tab 选中色: 深灰 #374151
  - 选题优先级图标: 添加颜色 (红/橙/灰)
- **UI 优化**:
  - 选题建议区添加图标说明（靠右对齐）
  - 跳过优化按钮添加 skip_next 图标，样式与生成内容按钮一致

### v2.15.0 - Viral-X 落地页
- **新增落地页**: `/public/landing.html` 完整营销落地页
- **设计风格**: Cinematic Enterprise Luxury 深色主题
  - 深色背景 (#141619)
  - 珊瑚色 CTA (#f05a4a)
  - Playfair Display 衬线标题 + Inter 无衬线正文
  - 玻璃面板效果 (backdrop-filter)
  - 药丸形状按钮
- **页面区块**:
  - Header: 固定顶部导航，含 Logo、功能链接、语言切换、CTA
  - Hero: 主标题"AI 创作引擎"、副标题、免费试用按钮、信任标识
  - 痛点共鸣: 4 个痛点卡片（不知道写什么、追热点太累、写出来没人看、模仿大V很难）
  - 解决方案: 4 步流程（追热点→写内容→优化爆款→一键发布）
  - 核心功能: 5 个功能交替图文布局（热点追踪、AI生成、语气模仿、爆款优化、一键发布）
  - 社会证明: 数据统计（10,000+内容、500+创作者、3分钟）+ 用户证言
  - CTA: 最终转化引导，强调免费试用
  - FAQ: 5 个常见问题，带展开/收起交互
  - Footer: 品牌 Logo、链接列表、社交媒体、版权信息
- **响应式设计**: 支持桌面和移动端

### v2.14.2 - 内容与优化页面UI修复
- **加载器居中**: 内容生成和爆款优化页面的加载器现在垂直居中显示
- **文案优化**: "待验证内容"改为"待优化内容"
- **输入框高度**: 优化意见输入框行数从3增加到5，更好展示默认提示
- **按钮样式统一**: 返回编辑按钮改为与开始爆款优化一致的主要按钮样式
- **评分居中**: 修复优化后评分数字在圆圈中的居中显示
- **精简功能**: 移除"查看原始报告"按钮

### v2.14.1 - 样式细节修复
- **侧边栏橙色图标**: 修复选中导航项图标颜色被覆盖的问题
  - 优化 CSS 选择器，保留 Material Icons 和 `text-orange-*` 类的原有颜色
  - 选中状态现在正确显示橙色图标
- **工作流线段覆盖**: 修复线段首尾露出的问题
  - 线段从 `left-0 w-full` 改为 `left: 24px; right: 24px;`
  - 线段现在从第一个节点中心开始，到最后一个节点中心结束
  - 圆形节点完全覆盖线段端点

### v2.14.0 - Tailwind CSS 浅色主题设计系统
- **技术栈升级**: 从自定义 CSS 迁移到 Tailwind CSS CDN
- **浅色主题**: 严格按照 1.html 模板实现浅色设计
- **字体系统**:
  - 标题: Playfair Display 衬线字体 + Georgia 回退
  - 正文: Inter 无衬线字体
- **图标系统**: 从 Emoji 迁移到 Material Icons Outlined
- **玻璃面板效果**:
  - `glass-panel`: 12px 模糊 + 白色半透明边框
  - `sidebar-glass`: 20px 模糊 + 微妙边框
- **配色方案** (浅色主题):
  - 背景: #F0F4F8 淡灰蓝色
  - 面板: rgba(255, 255, 255, 0.4~0.8) 白色半透明
  - 文字: #0f172a 深板岩色 / #64748b 灰色
  - 强调: amber-500 → orange-600 渐变
- **CSS 变量覆盖**: 覆盖旧 CSS 变量确保浅色主题一致性
- **组件重构**:
  - 登录页: 白色玻璃卡片 + 渐变 Logo + 浅色输入框
  - 侧边栏: 白色半透明背景 + 深色文字
  - 首页: 白色数据源卡片 + 悬停渐变效果 + 底部统计
  - 工作流程: 横向步骤条 + 白色圆形图标节点
  - 工具页: 白色工具卡片 + 紫色悬停效果
  - 个人页: 渐变头像 + 白色玻璃设置卡片
- **响应式适配**:
  - 桌面: 左侧边栏导航
  - 移动: 底部玻璃导航栏
- **背景效果**: 山脉风景图 (20% 透明度) + 浅色渐变遮罩

### v2.13.1 - 页面样式恢复 + 首页重设计
- **首页开始创作区重设计**: 参考 Viral-X 设计稿全新设计
  - 磨砂玻璃效果背景面板
  - 三列数据源卡片带悬停动画（上移 + 阴影 + 渐变背景）
  - 卡片特色配色：X 趋势（白色边框）、TopHub（橙色）、领域聚焦（紫色）
  - 悬停时右上角显示箭头图标
  - 底部统计区域：生成速度 + 支持平台
  - 响应式布局适配移动端
- **内容页 (content.js)**: 恢复输入区域、语气选择器、评分卡片、建议区域样式
  - 输入区卡片布局和标题样式
  - 三列语气选择器（热门/我的/订阅）
  - 评分展示卡片网格
  - 日志输出区域样式
- **优化页 (optimize.js)**: 恢复验证报告完整样式
  - 总分环形卡片（高/中/低三档配色）
  - 六维评分网格卡片
  - 优点/不足分析卡片
  - 策略列表和版本对比 Tab
- **图片描述页 (prompt.js)**: 恢复详情网格和元素标签样式
  - 风格/氛围/色调详情网格
  - 视觉元素标签云
- **配图页 (image.js)**: 恢复模式切换和搜索结果样式
  - AI 生成/搜索网图 Tab 切换
  - 搜索结果图片网格
  - 图片占位符区域
- **语气模仿器页面 (voice-mimicker.js)**: 恢复完整市场系统样式
  - 市场卡片网格布局
  - 我的生成器/订阅列表样式
  - 创建分析进度区域
  - 详情弹窗样式
- **通用样式补充**:
  - 新增 btn-danger 危险按钮样式
  - 新增 btn-large 大号按钮样式
  - 响应式布局适配移动端

### v2.13.0 - Cinematic Enterprise Luxury 设计系统
- **设计风格**: 全新 "电影质感企业奢华" 风格，灵感来自 Giga AI
- **统一深色主题**: 移除多主题切换，采用沉稳专业的深色调设计
- **色彩方案**:
  - 背景: Deep Charcoal Slate (#141619) 深板岩炭
  - 主色: White (#ffffff) 纯白用于主 CTA
  - 强调: Coral Red (#f05a4a) 珊瑚红点缀
  - 文字: Primary (#ffffff) / Secondary (#a1a1aa) / Muted (#71717a)
- **排版升级**: Cormorant Garamond 衬线字体用于标题，Inter 无衬线用于正文
- **组件风格**:
  - 按钮: 白色胶囊形状主 CTA，半透明边框次级按钮
  - 卡片: 深色半透明背景 + 微妙边框 + 柔和阴影
  - 导航: 深色渐变侧边栏，珊瑚红激活状态
- **背景效果**: 电影胶片质感噪点纹理 + 微妙渐变光晕
- **视觉氛围**: 沉稳、专业、精致、电影感

### v2.12.1 - 多主题选择系统
- **四种主题风格**: 用户可在 4 种主题间切换选择
  - 🌿 森林 (Light): 清新自然的浅色主题，森林绿配柠檬绿
  - 🌙 夜色 (Dark): 深邃森林夜景，萤火虫动效
  - 🌻 阳光 (Vibrant): 温暖活力风格，琥珀色配向日葵黄
  - 🍃 简约 (Minimal): 干净极简设计，石板灰配薄荷绿
- **主题切换优化**: 顶部按钮点击循环切换，个人页显示当前主题名称
- **侧边栏适配**: 每种主题有独立的侧边栏配色方案
- **背景装饰**: 每种主题有专属的背景装饰动效
- **主题色变量化**: 通过 CSS 自定义属性实现，便于扩展

### v2.12.0 - Organic Path 设计系统重构
- **设计系统升级**: 全面采用 "Organic Path" 设计风格，融合专业 SaaS 与自然美学
- **色彩方案**:
  - Primary: Deep Forest Green (#0A3D2E) 深森林绿
  - Secondary: Spring Green (#4ADE80) 青柠绿
  - Accent: Sun Yellow (#FACC15) 金黄色
  - 背景采用暖白色 (#FAF9F6) 和淡薄荷色 (#E8F5E9)
- **按钮系统**: 改为胶囊形状（pill），主按钮使用青柠绿配深森林绿文字
- **卡片组件**: 24px 大圆角，hover 时 lift 效果（translateY -6px）
- **侧边栏导航**: 深森林绿背景，激活项使用青柠绿高亮
- **背景装饰**: Light 主题添加森林绿光晕和柔和纹理，Dark 主题添加萤火虫动效
- **认证页面**: 添加起伏山丘 SVG 装饰背景
- **工作流程图**: 优化连接线和节点样式，增加视觉层次
- **Dark 主题**: 重新设计为 Forest Night 风格，深邃森林夜色
- **响应式优化**: 底部导航添加活动指示器圆点

### v2.11.1 - 语气模仿器页面优化
- **移除冗余标题**: 语气模仿器页面不再显示"X 帖子生成器"标题和流程图
- **导航定位修复**: 进入语气模仿器时正确激活"工具"导航而非"写作"
- **返回按钮优化**: 返回按钮正确导航回工具页面
- **卡片布局优化**: PC端市场/我的生成器/订阅卡片一行显示5个（响应式适配）
- **卡片信息完善**: 我的生成器和订阅卡片现在显示 Role 和 Core Traits

### v2.11.0 - 语气模仿器市场系统
- **市场模式**: 用户可将自己的语气模仿器开放到市场供他人订阅
- **订阅机制**: 用户可订阅市场中的模仿器，订阅后自动同步更新
- **撤回机制**: 开放者可随时撤回，撤回时断开所有订阅关系
- **隐私保护**: 市场中只展示 Role 和 Core Traits，不暴露完整 prompt
- **三列选择器**: 内容生成页的写作风格选择器改为三列（热门/我的/订阅）
- **Tab 导航**: 语气模仿器页面改为顶部 Tab 切换（市场/我的生成器）
- **新增字段**: voice_prompts 表新增 role、core_traits、subscriber_count 字段
- **新增表**: voice_prompt_subscriptions 订阅关系表
- **新增 API**: 市场列表、订阅/取消订阅、开放/撤回等接口

### v2.10.4 - 自由浏览 + 重新生成确认
- **返回不清除数据**: 点击返回按钮只切换视图，保留所有已生成内容
- **新增 `navigateTo` action**: 后端支持纯导航，不清除任何数据
- **重新生成确认弹窗**: 内容、优化、图片描述、配图环节重新生成时弹窗确认
- **趋势页重选确认**: 选择不同话题时提示将清除后续数据
- **导航栏状态优化**: 基于数据存在性判断步骤完成状态（有数据显示绿色勾）
- **自由浏览**: 用户可在各环节间自由切换查看已生成内容

### v2.10.3 - 用户界面文字优化
- 将所有用户可见的 "Claude CLI" 和 "Claude" 替换为 "AI"
- 统一使用中性的 AI 术语，隐藏底层实现细节
- 函数名保持不变，仅修改用户界面输出

### v2.10.2 - 趋势页面优化 & 内容持久化 & 使用统计
- 每个选题卡片中新增"下一步：生成内容"按钮
- 移除"查看原始报告"功能，简化界面
- 点击按钮直接选中话题并跳转到内容生成页面
- 生成内容后立即保存到数据库（`updateContentData`）
- 保存输入素材（`inputText`），返回编辑时可恢复
- 修复 `goBack` 逻辑：只清除目标步骤之后的数据，保留当前步骤数据
- 从优化页"返回编辑"现在能正确看到已生成的内容
- 语气模板新增使用次数统计（`usage_count`）
- 每次使用语气模板生成内容时自动 +1
- 语气模仿器列表显示使用次数
- 新增管理员调试端点 `/api/tools/voice-prompts/admin/list-all`

### v2.10.1 - 公共语气模板
- 语气模仿器支持公共/私有区分
- 公共模板所有用户可见可用，但无法查看 Prompt 内容
- 私有模板仅创建者可见，可查看完整 Prompt
- UI 区分显示：公共模板带绿色"公共"标签
- 管理员可通过 API 设置模板为公共

### v2.10.0 - 一级导航系统
- **PC 端**：左侧边栏导航（写作、工具、我的）
- **手机端**：底部页脚导航，自动隐藏侧边栏
- 新增工具页面：语气模仿器入口
- 新增个人页面：用户信息、主题切换、退出登录

### v2.9.22 - JSON 解析回退机制
- `JSON.parse()` 失败时使用正则回退提取关键字段
- 避免因 LLM 输出格式轻微错误导致任务失败

### v2.9.21 - 写作风格模拟
- 内容生成支持选择已保存的语气风格
- 自定义语气与默认人格互斥，避免 LLM 混淆
- 自定义语气只输出单版本

### v2.9.17~v2.9.20 - 语气模仿器
- 新增语气模仿器工具（抓取推文 → 分析风格 → 生成 Prompt）
- 改用 `advanced_search` API 获取更多推文
- 修复 user_id 保存问题

### v2.9.4~v2.9.16 - 领域趋势优化
- KOL 分组轮换抓取模式
- 数据库缓存机制
- 两阶段执行（抓取 + 分析分离）
- 时间轴显示修复

### v2.9.0 - 特定领域趋势追踪
- 新增 domain-trends Skill
- 支持 Web3、AI 等领域 KOL 追踪
- 配置化的 KOL 列表和关键词

## 数据库 Schema

### 主要表
- `users` - 用户信息
- `user_preferences` - 用户偏好
- `x_trends_raw` - X 趋势原始数据
- `x_trends_analysis` - X 趋势分析结果
- `tophub_trends_raw` - TopHub 原始数据
- `tophub_trends_analysis` - TopHub 分析结果
- `domain_trends_raw` - 领域趋势原始数据
- `domain_trends_analysis` - 领域趋势分析结果
- `voice_prompts` - 语气 Prompt 存储（含 role, core_traits, subscriber_count）
- `voice_prompt_subscriptions` - 语气模仿器订阅关系
- `token_usage` - Token 使用统计（user_id, task_id, workflow_step, skill_id, model, tokens, cost）

## 环境变量

```env
# Twitter API
TWITTER_API_IO_KEY=xxx

# Gemini API
GOOGLE_API_KEY=xxx

# JWT
JWT_SECRET=xxx

# 数据库
DATABASE_PATH=./data/app.db
```

## 开发命令

```bash
# 启动开发服务器
npm run dev

# TypeScript 类型检查
npx tsc --noEmit

# 运行测试
npm test
```
