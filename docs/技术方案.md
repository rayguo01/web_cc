# Web Claude Code 技术方案

## 1. 系统架构

```
┌─────────────┐      WebSocket      ┌─────────────────┐      子进程      ┌─────────────┐
│   浏览器     │ ◄──────────────────► │  Node.js 服务器  │ ◄──────────────► │ Claude CLI  │
└─────────────┘                      └─────────────────┘                  └─────────────┘
                                            │
                                            │ PostgreSQL
                                            ▼
                                     ┌─────────────┐
                                     │  Neon DB    │
                                     └─────────────┘
```

## 2. 技术栈

| 层级 | 技术选型 |
|------|----------|
| 前端 | HTML5 + CSS3 + Vanilla JS |
| 后端 | Node.js + Express |
| 实时通信 | WebSocket (ws库) |
| 数据库 | PostgreSQL (Neon) |
| 认证 | JWT + bcrypt |
| CLI调用 | child_process.spawn |

## 3. 数据库设计

### 3.1 用户表 (users)
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 会话表 (sessions)
```sql
CREATE TABLE sessions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    session_id VARCHAR(100) UNIQUE NOT NULL,  -- Claude CLI 会话ID
    title VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.3 消息表 (messages)
```sql
CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    session_id INTEGER REFERENCES sessions(id),
    role VARCHAR(20) NOT NULL,  -- 'user' 或 'assistant'
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. API 设计

### 4.1 REST API

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /api/auth/register | 用户注册 |
| POST | /api/auth/login | 用户登录 |
| GET | /api/sessions | 获取用户会话列表 |
| POST | /api/sessions | 创建新会话 |
| GET | /api/sessions/:id/messages | 获取会话消息历史 |
| DELETE | /api/sessions/:id | 删除会话 |

### 4.2 WebSocket 消息协议

**客户端发送：**
```json
{
    "type": "message",
    "sessionId": "xxx",
    "content": "用户输入内容"
}
```

**服务端发送：**
```json
{
    "type": "stream",
    "content": "流式输出片段"
}
```
```json
{
    "type": "done",
    "sessionId": "xxx"
}
```
```json
{
    "type": "error",
    "message": "错误信息"
}
```

## 5. Claude CLI 集成

### 5.1 调用方式
```javascript
const { spawn } = require('child_process');

// 新会话
spawn('claude', ['-p', prompt, '--output-format', 'stream-json']);

// 继续会话
spawn('claude', ['-p', prompt, '--session-id', sessionId, '--output-format', 'stream-json']);
```

### 5.2 输出解析
Claude CLI 的 `stream-json` 格式输出需要解析每行 JSON：
- `type: "assistant"` - 助手回复内容
- `type: "result"` - 最终结果，包含 session_id

## 6. 安全设计

1. **密码加密**：使用 bcrypt 哈希存储
2. **JWT 认证**：WebSocket 连接时验证 token
3. **输入验证**：防止注入攻击
4. **环境变量**：敏感配置不硬编码

## 7. 目录结构

```
web-cc/
├── docs/
│   ├── 需求.md
│   ├── 技术方案.md
│   └── summary.md
├── src/
│   ├── server.js          # 主入口
│   ├── config/
│   │   └── database.js    # 数据库配置
│   ├── routes/
│   │   ├── auth.js        # 认证路由
│   │   └── sessions.js    # 会话路由
│   ├── services/
│   │   └── claude.js      # Claude CLI 服务
│   ├── middleware/
│   │   └── auth.js        # JWT 中间件
│   └── websocket/
│       └── handler.js     # WebSocket 处理
├── public/
│   ├── index.html
│   ├── css/
│   │   └── style.css
│   └── js/
│       └── app.js
├── package.json
└── .env
```

## 8. 部署要求

- Node.js >= 18
- Claude CLI 已安装并配置
- 网络能访问 Neon 数据库
