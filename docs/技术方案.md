# Viral-X 技术方案

## 1. 系统架构

```
┌──────────────────────────────────────────────────────────────────────────┐
│                              用户终端                                      │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                   │
│  │   PC 浏览器  │    │  移动端浏览器 │    │  X 平台     │                   │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                   │
└─────────┼──────────────────┼──────────────────┼──────────────────────────┘
          │                  │                  │
          └────────────┬─────┴──────────────────┘
                       │ HTTPS / WebSocket
                       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                         Node.js 服务器 (Express)                          │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                           路由层                                      │ │
│  │  auth │ twitter │ tasks │ skills │ tools │ stats │ admin │ sessions │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                          服务层                                       │ │
│  │  scheduler │ skillCache │ tokenUsageDb │ trendsDb │ voicePromptDb   │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                       WebSocket 处理器                               │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────┬──────────────────────────────────────────┘
                                │
          ┌─────────────────────┼─────────────────────┐
          │                     │                     │
          ▼                     ▼                     ▼
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│   PostgreSQL    │   │   Claude CLI    │   │  外部 API       │
│   (Neon DB)     │   │   (AI Skills)   │   │  - Twitter API  │
│                 │   │                 │   │  - Gemini API   │
│   schema:       │   │   - x-trends    │   │  - twitterapi.io│
│   web_cc        │   │   - tophub      │   │                 │
└─────────────────┘   │   - content     │   └─────────────────┘
                      │   - viral       │
                      │   - voice       │
                      │   - image       │
                      └─────────────────┘
```

## 2. 技术栈

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 前端 | HTML5 + CSS3 + Vanilla JS | 无框架依赖，轻量快速 |
| 后端 | Node.js + Express | RESTful API + WebSocket |
| 实时通信 | WebSocket (ws) | Claude CLI 流式输出 |
| 数据库 | PostgreSQL (Neon) | 云数据库，支持 schema 隔离 |
| 认证 | JWT + bcrypt + OAuth 2.0 | 支持密码登录和 Twitter 登录 |
| AI 能力 | Claude CLI (ts-node) | 热点抓取、内容生成、爆款优化 |
| 图片生成 | Google Gemini API | AI 配图生成 |
| 定时任务 | node-cron | 每小时自动抓取热点 |

## 3. 数据库设计

### 3.1 用户表 (users)

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255),              -- Twitter 登录用户可为空
    twitter_id VARCHAR(100) UNIQUE,          -- Twitter 用户 ID
    avatar_url VARCHAR(500),                 -- 头像 URL
    is_admin BOOLEAN DEFAULT FALSE,          -- 管理员标识
    invited_by_code VARCHAR(20),             -- 注册时使用的邀请码
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 Twitter 凭证表 (twitter_credentials)

```sql
CREATE TABLE twitter_credentials (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE UNIQUE,
    twitter_user_id VARCHAR(100),
    twitter_username VARCHAR(100),
    access_token TEXT NOT NULL,
    refresh_token TEXT,
    token_expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.3 帖子生成任务表 (post_tasks)

```sql
CREATE TABLE post_tasks (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    current_step VARCHAR(30) NOT NULL DEFAULT 'trends',
    workflow_config JSONB DEFAULT '{"steps":["trends","content","optimize","prompt","image","submit"]}',
    trends_data JSONB,                       -- 热点数据
    content_data JSONB,                      -- 生成的内容
    optimize_data JSONB,                     -- 优化后的内容
    prompt_data JSONB,                       -- 配图提示词
    image_data JSONB,                        -- 图片数据
    final_content TEXT,                      -- 最终帖子内容
    final_image_path VARCHAR(500),           -- 最终配图路径
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);
```

### 3.4 帖子历史表 (post_history)

```sql
CREATE TABLE post_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    task_id INTEGER REFERENCES post_tasks(id) ON DELETE SET NULL,
    trend_source VARCHAR(30),
    trend_topic VARCHAR(500),
    final_content TEXT NOT NULL,
    final_image_path VARCHAR(500),
    viral_score INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.5 写作风格模仿表 (voice_prompts)

```sql
CREATE TABLE voice_prompts (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    username VARCHAR(100) NOT NULL,          -- 模仿对象的用户名
    display_name VARCHAR(200),
    avatar_url VARCHAR(500),
    tweet_count INTEGER DEFAULT 0,           -- 分析的推文数
    total_chars INTEGER DEFAULT 0,
    prompt_content TEXT NOT NULL,            -- 生成的模仿 Prompt
    sample_tweets JSONB,                     -- 样本推文
    role VARCHAR(200),                       -- 角色定位（市场展示）
    core_traits TEXT,                        -- 核心特质 JSON
    domains TEXT,                            -- 领域标签 JSON
    is_public BOOLEAN DEFAULT FALSE,         -- 是否开放到市场
    usage_count INTEGER DEFAULT 0,           -- 使用次数
    subscriber_count INTEGER DEFAULT 0,      -- 订阅者数
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.6 写作风格订阅表 (voice_prompt_subscriptions)

```sql
CREATE TABLE voice_prompt_subscriptions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    prompt_id INTEGER REFERENCES voice_prompts(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, prompt_id)
);
```

### 3.7 趋势数据表 (trends_data)

```sql
CREATE TABLE trends_data (
    id SERIAL PRIMARY KEY,
    skill_id VARCHAR(100) NOT NULL,          -- x-trends 或 tophub-trends
    hour_key VARCHAR(20) NOT NULL,           -- 小时标识，如 2026011612
    raw_data JSONB,                          -- 原始抓取数据
    analysis_result JSONB,                   -- 分析结果
    analysis_status VARCHAR(20) DEFAULT 'pending',
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(skill_id, hour_key)
);
```

### 3.8 Token 使用统计表 (token_usage)

```sql
CREATE TABLE token_usage (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    task_id INTEGER REFERENCES post_tasks(id) ON DELETE SET NULL,
    workflow_step VARCHAR(30),               -- 工作流步骤
    skill_id VARCHAR(100),                   -- AI Skill ID
    model VARCHAR(100),                      -- 使用的模型
    input_tokens INTEGER DEFAULT 0,
    output_tokens INTEGER DEFAULT 0,
    cache_creation_tokens INTEGER DEFAULT 0,
    cache_read_tokens INTEGER DEFAULT 0,
    cost_usd DECIMAL(12, 8) DEFAULT 0,       -- 估算成本（美元）
    duration_ms INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.9 邀请码表 (invitation_codes)

```sql
CREATE TABLE invitation_codes (
    id SERIAL PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    note VARCHAR(200),                       -- 备注
    created_by INTEGER REFERENCES users(id) ON DELETE SET NULL,
    used_by INTEGER REFERENCES users(id) ON DELETE SET NULL,
    used_at TIMESTAMP,
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. API 设计

### 4.1 认证相关 (/api/auth)

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /register | 用户注册（需邀请码） |
| POST | /login | 用户登录 |
| GET | /me | 获取当前用户信息 |

### 4.2 Twitter OAuth (/api/twitter)

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /auth | 发起 Twitter OAuth 授权 |
| GET | /callback | OAuth 回调处理 |
| GET | /status | 获取 Twitter 授权状态 |
| POST | /disconnect | 断开 Twitter 连接 |
| POST | /post | 发布推文到 X 平台 |

### 4.3 任务管理 (/api/tasks)

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /current | 获取当前进行中的任务 |
| POST | / | 创建新任务 |
| PUT | /:id/step | 更新任务步骤数据 |
| POST | /:id/next | 进入下一步 |
| POST | /:id/complete | 完成任务 |
| DELETE | /:id | 删除任务 |

### 4.4 AI Skills (/api/skills)

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /:skillId/cached | 获取缓存的热点数据（只读） |
| POST | /:skillId/execute | 执行 AI Skill |

### 4.5 工具 (/api/tools)

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /voice-prompts | 获取可用的写作风格列表 |
| GET | /voice-prompts/market | 获取市场上的写作风格 |
| GET | /voice-prompts/mine | 获取我创建的写作风格 |
| GET | /voice-prompts/subscribed | 获取我订阅的写作风格 |
| POST | /voice-prompts | 创建写作风格 |
| POST | /voice-prompts/:id/publish | 发布到市场 |
| POST | /voice-prompts/:id/unpublish | 从市场撤回 |
| POST | /voice-prompts/:id/subscribe | 订阅 |
| DELETE | /voice-prompts/:id/subscribe | 取消订阅 |
| DELETE | /voice-prompts/:id | 删除写作风格 |

### 4.6 统计 (/api/stats)

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /user | 获取用户统计数据 |

### 4.7 管理后台 (/api/admin)

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /users | 获取用户列表 |
| GET | /stats | 获取系统统计 |
| GET | /token-usage | 获取 Token 使用统计 |
| POST | /invitations | 创建邀请码 |
| GET | /invitations | 获取邀请码列表 |
| DELETE | /invitations/:id | 删除邀请码 |

### 4.8 邀请码 (/api/invitations)

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /validate | 验证邀请码有效性 |

## 5. AI Skills 集成

### 5.1 Skills 列表

| Skill ID | 功能 | 输入 | 输出 |
|----------|------|------|------|
| x-trends | X 平台热点抓取 | 无 | 热点话题列表 + 分析 |
| tophub-trends | 国内热点抓取 | 无 | 多平台热点汇总 |
| content-writer | 内容生成 | 热点 + 风格 | 帖子内容 |
| viral-verification | 爆款优化 | 原始内容 | 优化后内容 + 评分 |
| prompt-generator | 配图提示词 | 帖子内容 | 图片 Prompt |
| gemini-image-gen | AI 配图 | 图片 Prompt | 图片 URL |
| voice-mimicker | 写作风格分析 | 用户名 | 风格 Prompt |

### 5.2 定时任务调度

```javascript
// 每小时第 1 分钟自动抓取热点
cron.schedule('1 * * * *', () => {
    scheduler.fetchAllTrends();  // 执行 x-trends 和 tophub-trends
}, { timezone: 'Asia/Shanghai' });
```

### 5.3 缓存机制

- 热点数据缓存在内存 + 磁盘 (`outputs/.cache/`)
- 用户访问热点 API 只读取缓存，不触发新抓取
- 服务重启后从磁盘恢复缓存

## 6. 安全设计

| 安全措施 | 实现方式 |
|----------|----------|
| 密码加密 | bcrypt 哈希存储 |
| JWT 认证 | 所有 API 请求携带 token |
| OAuth 2.0 | Twitter 第三方登录 |
| 邀请码系统 | 新用户注册需邀请码 |
| 管理员权限 | is_admin 字段控制后台访问 |
| 输入验证 | 防止 SQL 注入和 XSS |
| Schema 隔离 | 数据库使用独立 schema |

## 7. 目录结构

```
web-cc/
├── .claude/                    # AI Skills 脚本
│   ├── content-writer/         # 内容生成
│   ├── viral-verification/     # 爆款优化
│   ├── voice-mimicker/         # 写作风格分析
│   ├── x-trends/               # X 热点抓取
│   ├── tophub-trends/          # 国内热点抓取
│   ├── prompt-generator/       # 配图提示词
│   ├── gemini-image-gen/       # Gemini 图片生成
│   └── utils/                  # 公共工具
├── docs/                       # 文档
│   ├── 启动说明.md
│   ├── 技术方案.md
│   └── summary.md
├── outputs/                    # 输出文件
│   ├── .cache/                 # 缓存文件
│   ├── images/                 # 生成的图片
│   └── trends/                 # 热点分析报告
├── public/                     # 前端静态文件
│   ├── index.html              # 落地页
│   ├── login.html              # PC 登录页
│   ├── login-mobile.html       # 移动端登录页
│   ├── admin.html              # 管理后台
│   ├── css/
│   │   ├── style.css           # 基础样式
│   │   └── generator.css       # 生成器样式
│   └── js/
│       ├── app.js              # 主应用（生成器）
│       └── generator/          # 生成器模块
│           ├── index.js        # 路由和初始化
│           ├── state.js        # 状态管理
│           ├── workflow.js     # 工作流控制
│           └── pages/          # 各步骤页面
│               ├── home.js
│               ├── trends.js
│               ├── content.js
│               ├── optimize.js
│               ├── image.js
│               ├── submit.js
│               ├── history.js
│               └── voice-mimicker.js
├── src/                        # 后端代码
│   ├── server.js               # 入口文件
│   ├── config/
│   │   └── database.js         # 数据库配置
│   ├── middleware/
│   │   ├── auth.js             # JWT 认证
│   │   └── adminAuth.js        # 管理员认证
│   ├── routes/
│   │   ├── auth.js             # 认证路由
│   │   ├── twitter.js          # Twitter OAuth
│   │   ├── tasks.js            # 任务管理
│   │   ├── skills.js           # AI Skills
│   │   ├── tools.js            # 工具（写作风格）
│   │   ├── stats.js            # 统计
│   │   ├── admin.js            # 管理后台
│   │   ├── invitations.js      # 邀请码
│   │   └── sessions.js         # 会话管理
│   ├── services/
│   │   ├── claude.js           # Claude CLI 服务
│   │   ├── scheduler.js        # 定时任务调度
│   │   ├── skillCache.js       # 缓存服务
│   │   ├── tokenUsageDb.js     # Token 统计
│   │   ├── trendsDb.js         # 趋势数据
│   │   └── voicePromptDb.js    # 写作风格数据
│   └── websocket/
│       └── handler.js          # WebSocket 处理
├── package.json
├── .env                        # 环境变量（不提交）
├── .env.example                # 环境变量示例
└── CLAUDE.md                   # AI 助手指引
```

## 8. 部署要求

| 要求 | 说明 |
|------|------|
| Node.js | >= 18 |
| Claude CLI | 已安装并配置 API Key |
| PostgreSQL | Neon 云数据库，schema=web_cc |
| 网络 | 能访问 Twitter API、Gemini API |
| 域名 | 生产环境需 HTTPS |

## 9. 工作流程

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  热点选择 │ ─► │  内容生成 │ ─► │  爆款优化 │ ─► │  配图提示 │ ─► │  生成配图 │ ─► │  发布帖子 │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
     │               │               │               │               │               │
     ▼               ▼               ▼               ▼               ▼               ▼
 x-trends      content-writer   viral-verify   prompt-gen      gemini-img     twitter-post
 tophub-trends   + voice-style
```

每个步骤的数据都保存在 `post_tasks` 表中，支持断点续作。
